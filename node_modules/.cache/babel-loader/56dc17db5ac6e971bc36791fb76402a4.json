{"ast":null,"code":"/**\r\n * DevExtreme (ui/selection/selection.strategy.deferred.js)\r\n * Version: 19.2.7\r\n * Build date: Thu Mar 26 2020\r\n *\r\n * Copyright (c) 2012 - 2020 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\n\"use strict\";\n\nvar typeUtils = require(\"../../core/utils/type\");\n\nvar SelectionStrategy = require(\"./selection.strategy\");\n\nvar errors = require(\"../widget/ui.errors\");\n\nvar dataQuery = require(\"../../data/query\");\n\nvar Deferred = require(\"../../core/utils/deferred\").Deferred;\n\nmodule.exports = SelectionStrategy.inherit({\n  getSelectedItems: function getSelectedItems() {\n    return this._loadFilteredData(this.options.selectionFilter);\n  },\n  getSelectedItemKeys: function getSelectedItemKeys() {\n    var d = new Deferred();\n    var that = this;\n    var key = this.options.key();\n    var select = typeUtils.isString(key) ? [key] : key;\n\n    this._loadFilteredData(this.options.selectionFilter, null, select).done(function (items) {\n      var keys = items.map(function (item) {\n        return that.options.keyOf(item);\n      });\n      d.resolve(keys);\n    }).fail(d.reject);\n\n    return d.promise();\n  },\n  selectedItemKeys: function selectedItemKeys(keys, preserve, isDeselect, isSelectAll) {\n    if (isSelectAll) {\n      var filter = this.options.filter();\n\n      if (!filter) {\n        this._setOption(\"selectionFilter\", isDeselect ? [] : null);\n      } else {\n        this._addSelectionFilter(isDeselect, filter, isSelectAll);\n      }\n    } else {\n      if (!preserve) {\n        this._setOption(\"selectionFilter\", []);\n      }\n\n      for (var i = 0; i < keys.length; i++) {\n        if (isDeselect) {\n          this.removeSelectedItem(keys[i]);\n        } else {\n          this.addSelectedItem(keys[i]);\n        }\n      }\n    }\n\n    this.onSelectionChanged();\n    return new Deferred().resolve();\n  },\n  setSelectedItems: function setSelectedItems(keys) {\n    this._setOption(\"selectionFilter\", null);\n\n    for (var i = 0; i < keys.length; i++) {\n      this.addSelectedItem(keys[i]);\n    }\n  },\n  isItemDataSelected: function isItemDataSelected(itemData) {\n    return this.isItemKeySelected(itemData);\n  },\n  isItemKeySelected: function isItemKeySelected(itemData) {\n    var selectionFilter = this.options.selectionFilter;\n\n    if (!selectionFilter) {\n      return true;\n    }\n\n    return !!dataQuery([itemData]).filter(selectionFilter).toArray().length;\n  },\n  _processSelectedItem: function _processSelectedItem(key) {\n    var keyField = this.options.key();\n    var filter = [keyField, \"=\", key];\n\n    if (Array.isArray(keyField)) {\n      filter = [];\n\n      for (var i = 0; i < keyField.length; i++) {\n        filter.push([keyField[i], \"=\", key[keyField[i]]]);\n\n        if (i !== keyField.length - 1) {\n          filter.push(\"and\");\n        }\n      }\n    }\n\n    return filter;\n  },\n  addSelectedItem: function addSelectedItem(key) {\n    var filter = this._processSelectedItem(key);\n\n    this._addSelectionFilter(false, filter);\n  },\n  removeSelectedItem: function removeSelectedItem(key) {\n    var filter = this._processSelectedItem(key);\n\n    this._addSelectionFilter(true, filter);\n  },\n  validate: function validate() {\n    var key = this.options.key;\n\n    if (key && void 0 === key()) {\n      throw errors.Error(\"E1042\", \"Deferred selection\");\n    }\n  },\n  _findSubFilter: function _findSubFilter(selectionFilter, filter) {\n    if (!selectionFilter) {\n      return -1;\n    }\n\n    var filterString = JSON.stringify(filter);\n\n    for (var index = 0; index < selectionFilter.length; index++) {\n      var subFilter = selectionFilter[index];\n\n      if (subFilter && JSON.stringify(subFilter) === filterString) {\n        return index;\n      }\n    }\n\n    return -1;\n  },\n  _isLastSubFilter: function _isLastSubFilter(selectionFilter, filter) {\n    if (selectionFilter && filter) {\n      return this._findSubFilter(selectionFilter, filter) === selectionFilter.length - 1 || 0 === this._findSubFilter([selectionFilter], filter);\n    }\n\n    return false;\n  },\n  _addFilterOperator: function _addFilterOperator(selectionFilter, filterOperator) {\n    if (selectionFilter.length > 1 && typeUtils.isString(selectionFilter[1]) && selectionFilter[1] !== filterOperator) {\n      selectionFilter = [selectionFilter];\n    }\n\n    if (selectionFilter.length) {\n      selectionFilter.push(filterOperator);\n    }\n\n    return selectionFilter;\n  },\n  _denormalizeFilter: function _denormalizeFilter(filter) {\n    if (filter && typeUtils.isString(filter[0])) {\n      filter = [filter];\n    }\n\n    return filter;\n  },\n  _addSelectionFilter: function _addSelectionFilter(isDeselect, filter, isSelectAll) {\n    var that = this;\n    var needAddFilter = true;\n    var currentFilter = isDeselect ? [\"!\", filter] : filter;\n    var currentOperation = isDeselect ? \"and\" : \"or\";\n    var selectionFilter = that.options.selectionFilter || [];\n    selectionFilter = that._denormalizeFilter(selectionFilter);\n\n    if (selectionFilter && selectionFilter.length) {\n      that._removeSameFilter(selectionFilter, filter, isDeselect, isSelectAll);\n\n      var lastOperation = that._removeSameFilter(selectionFilter, filter, !isDeselect);\n\n      if (lastOperation && (\"or\" !== lastOperation && isDeselect || \"and\" !== lastOperation && !isDeselect)) {\n        needAddFilter = false;\n        selectionFilter = [];\n      }\n\n      if (needAddFilter) {\n        selectionFilter = that._addFilterOperator(selectionFilter, currentOperation);\n      }\n    }\n\n    if (needAddFilter) {\n      selectionFilter.push(currentFilter);\n    }\n\n    selectionFilter = that._normalizeFilter(selectionFilter);\n\n    that._setOption(\"selectionFilter\", !isDeselect && !selectionFilter.length ? null : selectionFilter);\n  },\n  _normalizeFilter: function _normalizeFilter(filter) {\n    if (filter && 1 === filter.length) {\n      filter = filter[0];\n    }\n\n    return filter;\n  },\n  _removeFilterByIndex: function _removeFilterByIndex(filter, filterIndex, isSelectAll) {\n    var lastRemoveOperation;\n\n    if (filterIndex > 0) {\n      lastRemoveOperation = filter.splice(filterIndex - 1, 2)[0];\n    } else {\n      lastRemoveOperation = filter.splice(filterIndex, 2)[1] || \"undefined\";\n    }\n\n    if (isSelectAll && \"and\" === lastRemoveOperation) {\n      filter.splice(0, filter.length);\n    }\n\n    return lastRemoveOperation;\n  },\n  _removeSameFilter: function _removeSameFilter(selectionFilter, filter, inverted, isSelectAll) {\n    filter = inverted ? [\"!\", filter] : filter;\n\n    var filterIndex = this._findSubFilter(selectionFilter, filter);\n\n    if (JSON.stringify(filter) === JSON.stringify(selectionFilter)) {\n      selectionFilter.splice(0, selectionFilter.length);\n      return \"undefined\";\n    }\n\n    if (filterIndex >= 0) {\n      return this._removeFilterByIndex(selectionFilter, filterIndex, isSelectAll);\n    } else {\n      for (var i = 0; i < selectionFilter.length; i++) {\n        var lastRemoveOperation = Array.isArray(selectionFilter[i]) && selectionFilter[i].length > 2 && this._removeSameFilter(selectionFilter[i], filter, false, isSelectAll);\n\n        if (lastRemoveOperation) {\n          if (!selectionFilter[i].length) {\n            this._removeFilterByIndex(selectionFilter, i, isSelectAll);\n          } else {\n            if (1 === selectionFilter[i].length) {\n              selectionFilter[i] = selectionFilter[i][0];\n            }\n          }\n\n          return lastRemoveOperation;\n        }\n      }\n    }\n  },\n  getSelectAllState: function getSelectAllState() {\n    var filter = this.options.filter();\n    var selectionFilter = this.options.selectionFilter;\n\n    if (!selectionFilter) {\n      return true;\n    }\n\n    if (!selectionFilter.length) {\n      return false;\n    }\n\n    if (!filter || !filter.length) {\n      return;\n    }\n\n    selectionFilter = this._denormalizeFilter(selectionFilter);\n\n    if (this._isLastSubFilter(selectionFilter, filter)) {\n      return true;\n    }\n\n    if (this._isLastSubFilter(selectionFilter, [\"!\", filter])) {\n      return false;\n    }\n\n    return;\n  }\n});","map":{"version":3,"sources":["C:/Users/va112/Documents/Webdev/React/Corona/node_modules/devextreme/ui/selection/selection.strategy.deferred.js"],"names":["typeUtils","require","SelectionStrategy","errors","dataQuery","Deferred","module","exports","inherit","getSelectedItems","_loadFilteredData","options","selectionFilter","getSelectedItemKeys","d","that","key","select","isString","done","items","keys","map","item","keyOf","resolve","fail","reject","promise","selectedItemKeys","preserve","isDeselect","isSelectAll","filter","_setOption","_addSelectionFilter","i","length","removeSelectedItem","addSelectedItem","onSelectionChanged","setSelectedItems","isItemDataSelected","itemData","isItemKeySelected","toArray","_processSelectedItem","keyField","Array","isArray","push","validate","Error","_findSubFilter","filterString","JSON","stringify","index","subFilter","_isLastSubFilter","_addFilterOperator","filterOperator","_denormalizeFilter","needAddFilter","currentFilter","currentOperation","_removeSameFilter","lastOperation","_normalizeFilter","_removeFilterByIndex","filterIndex","lastRemoveOperation","splice","inverted","getSelectAllState"],"mappings":"AAAA;;;;;;;;AAQA;;AACA,IAAIA,SAAS,GAAGC,OAAO,CAAC,uBAAD,CAAvB;;AACA,IAAIC,iBAAiB,GAAGD,OAAO,CAAC,sBAAD,CAA/B;;AACA,IAAIE,MAAM,GAAGF,OAAO,CAAC,qBAAD,CAApB;;AACA,IAAIG,SAAS,GAAGH,OAAO,CAAC,kBAAD,CAAvB;;AACA,IAAII,QAAQ,GAAGJ,OAAO,CAAC,2BAAD,CAAP,CAAqCI,QAApD;;AACAC,MAAM,CAACC,OAAP,GAAiBL,iBAAiB,CAACM,OAAlB,CAA0B;AACvCC,EAAAA,gBAAgB,EAAE,4BAAW;AACzB,WAAO,KAAKC,iBAAL,CAAuB,KAAKC,OAAL,CAAaC,eAApC,CAAP;AACH,GAHsC;AAIvCC,EAAAA,mBAAmB,EAAE,+BAAW;AAC5B,QAAIC,CAAC,GAAG,IAAIT,QAAJ,EAAR;AACA,QAAIU,IAAI,GAAG,IAAX;AACA,QAAIC,GAAG,GAAG,KAAKL,OAAL,CAAaK,GAAb,EAAV;AACA,QAAIC,MAAM,GAAGjB,SAAS,CAACkB,QAAV,CAAmBF,GAAnB,IAA0B,CAACA,GAAD,CAA1B,GAAkCA,GAA/C;;AACA,SAAKN,iBAAL,CAAuB,KAAKC,OAAL,CAAaC,eAApC,EAAqD,IAArD,EAA2DK,MAA3D,EAAmEE,IAAnE,CAAwE,UAASC,KAAT,EAAgB;AACpF,UAAIC,IAAI,GAAGD,KAAK,CAACE,GAAN,CAAU,UAASC,IAAT,EAAe;AAChC,eAAOR,IAAI,CAACJ,OAAL,CAAaa,KAAb,CAAmBD,IAAnB,CAAP;AACH,OAFU,CAAX;AAGAT,MAAAA,CAAC,CAACW,OAAF,CAAUJ,IAAV;AACH,KALD,EAKGK,IALH,CAKQZ,CAAC,CAACa,MALV;;AAMA,WAAOb,CAAC,CAACc,OAAF,EAAP;AACH,GAhBsC;AAiBvCC,EAAAA,gBAAgB,EAAE,0BAASR,IAAT,EAAeS,QAAf,EAAyBC,UAAzB,EAAqCC,WAArC,EAAkD;AAChE,QAAIA,WAAJ,EAAiB;AACb,UAAIC,MAAM,GAAG,KAAKtB,OAAL,CAAasB,MAAb,EAAb;;AACA,UAAI,CAACA,MAAL,EAAa;AACT,aAAKC,UAAL,CAAgB,iBAAhB,EAAmCH,UAAU,GAAG,EAAH,GAAQ,IAArD;AACH,OAFD,MAEO;AACH,aAAKI,mBAAL,CAAyBJ,UAAzB,EAAqCE,MAArC,EAA6CD,WAA7C;AACH;AACJ,KAPD,MAOO;AACH,UAAI,CAACF,QAAL,EAAe;AACX,aAAKI,UAAL,CAAgB,iBAAhB,EAAmC,EAAnC;AACH;;AACD,WAAK,IAAIE,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGf,IAAI,CAACgB,MAAzB,EAAiCD,CAAC,EAAlC,EAAsC;AAClC,YAAIL,UAAJ,EAAgB;AACZ,eAAKO,kBAAL,CAAwBjB,IAAI,CAACe,CAAD,CAA5B;AACH,SAFD,MAEO;AACH,eAAKG,eAAL,CAAqBlB,IAAI,CAACe,CAAD,CAAzB;AACH;AACJ;AACJ;;AACD,SAAKI,kBAAL;AACA,WAAQ,IAAInC,QAAJ,EAAD,CAAeoB,OAAf,EAAP;AACH,GAvCsC;AAwCvCgB,EAAAA,gBAAgB,EAAE,0BAASpB,IAAT,EAAe;AAC7B,SAAKa,UAAL,CAAgB,iBAAhB,EAAmC,IAAnC;;AACA,SAAK,IAAIE,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGf,IAAI,CAACgB,MAAzB,EAAiCD,CAAC,EAAlC,EAAsC;AAClC,WAAKG,eAAL,CAAqBlB,IAAI,CAACe,CAAD,CAAzB;AACH;AACJ,GA7CsC;AA8CvCM,EAAAA,kBAAkB,EAAE,4BAASC,QAAT,EAAmB;AACnC,WAAO,KAAKC,iBAAL,CAAuBD,QAAvB,CAAP;AACH,GAhDsC;AAiDvCC,EAAAA,iBAAiB,EAAE,2BAASD,QAAT,EAAmB;AAClC,QAAI/B,eAAe,GAAG,KAAKD,OAAL,CAAaC,eAAnC;;AACA,QAAI,CAACA,eAAL,EAAsB;AAClB,aAAO,IAAP;AACH;;AACD,WAAO,CAAC,CAACR,SAAS,CAAC,CAACuC,QAAD,CAAD,CAAT,CAAsBV,MAAtB,CAA6BrB,eAA7B,EAA8CiC,OAA9C,GAAwDR,MAAjE;AACH,GAvDsC;AAwDvCS,EAAAA,oBAAoB,EAAE,8BAAS9B,GAAT,EAAc;AAChC,QAAI+B,QAAQ,GAAG,KAAKpC,OAAL,CAAaK,GAAb,EAAf;AACA,QAAIiB,MAAM,GAAG,CAACc,QAAD,EAAW,GAAX,EAAgB/B,GAAhB,CAAb;;AACA,QAAIgC,KAAK,CAACC,OAAN,CAAcF,QAAd,CAAJ,EAA6B;AACzBd,MAAAA,MAAM,GAAG,EAAT;;AACA,WAAK,IAAIG,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGW,QAAQ,CAACV,MAA7B,EAAqCD,CAAC,EAAtC,EAA0C;AACtCH,QAAAA,MAAM,CAACiB,IAAP,CAAY,CAACH,QAAQ,CAACX,CAAD,CAAT,EAAc,GAAd,EAAmBpB,GAAG,CAAC+B,QAAQ,CAACX,CAAD,CAAT,CAAtB,CAAZ;;AACA,YAAIA,CAAC,KAAKW,QAAQ,CAACV,MAAT,GAAkB,CAA5B,EAA+B;AAC3BJ,UAAAA,MAAM,CAACiB,IAAP,CAAY,KAAZ;AACH;AACJ;AACJ;;AACD,WAAOjB,MAAP;AACH,GArEsC;AAsEvCM,EAAAA,eAAe,EAAE,yBAASvB,GAAT,EAAc;AAC3B,QAAIiB,MAAM,GAAG,KAAKa,oBAAL,CAA0B9B,GAA1B,CAAb;;AACA,SAAKmB,mBAAL,CAAyB,KAAzB,EAAgCF,MAAhC;AACH,GAzEsC;AA0EvCK,EAAAA,kBAAkB,EAAE,4BAAStB,GAAT,EAAc;AAC9B,QAAIiB,MAAM,GAAG,KAAKa,oBAAL,CAA0B9B,GAA1B,CAAb;;AACA,SAAKmB,mBAAL,CAAyB,IAAzB,EAA+BF,MAA/B;AACH,GA7EsC;AA8EvCkB,EAAAA,QAAQ,EAAE,oBAAW;AACjB,QAAInC,GAAG,GAAG,KAAKL,OAAL,CAAaK,GAAvB;;AACA,QAAIA,GAAG,IAAI,KAAK,CAAL,KAAWA,GAAG,EAAzB,EAA6B;AACzB,YAAMb,MAAM,CAACiD,KAAP,CAAa,OAAb,EAAsB,oBAAtB,CAAN;AACH;AACJ,GAnFsC;AAoFvCC,EAAAA,cAAc,EAAE,wBAASzC,eAAT,EAA0BqB,MAA1B,EAAkC;AAC9C,QAAI,CAACrB,eAAL,EAAsB;AAClB,aAAO,CAAC,CAAR;AACH;;AACD,QAAI0C,YAAY,GAAGC,IAAI,CAACC,SAAL,CAAevB,MAAf,CAAnB;;AACA,SAAK,IAAIwB,KAAK,GAAG,CAAjB,EAAoBA,KAAK,GAAG7C,eAAe,CAACyB,MAA5C,EAAoDoB,KAAK,EAAzD,EAA6D;AACzD,UAAIC,SAAS,GAAG9C,eAAe,CAAC6C,KAAD,CAA/B;;AACA,UAAIC,SAAS,IAAIH,IAAI,CAACC,SAAL,CAAeE,SAAf,MAA8BJ,YAA/C,EAA6D;AACzD,eAAOG,KAAP;AACH;AACJ;;AACD,WAAO,CAAC,CAAR;AACH,GAhGsC;AAiGvCE,EAAAA,gBAAgB,EAAE,0BAAS/C,eAAT,EAA0BqB,MAA1B,EAAkC;AAChD,QAAIrB,eAAe,IAAIqB,MAAvB,EAA+B;AAC3B,aAAO,KAAKoB,cAAL,CAAoBzC,eAApB,EAAqCqB,MAArC,MAAiDrB,eAAe,CAACyB,MAAhB,GAAyB,CAA1E,IAA+E,MAAM,KAAKgB,cAAL,CAAoB,CAACzC,eAAD,CAApB,EAAuCqB,MAAvC,CAA5F;AACH;;AACD,WAAO,KAAP;AACH,GAtGsC;AAuGvC2B,EAAAA,kBAAkB,EAAE,4BAAShD,eAAT,EAA0BiD,cAA1B,EAA0C;AAC1D,QAAIjD,eAAe,CAACyB,MAAhB,GAAyB,CAAzB,IAA8BrC,SAAS,CAACkB,QAAV,CAAmBN,eAAe,CAAC,CAAD,CAAlC,CAA9B,IAAwEA,eAAe,CAAC,CAAD,CAAf,KAAuBiD,cAAnG,EAAmH;AAC/GjD,MAAAA,eAAe,GAAG,CAACA,eAAD,CAAlB;AACH;;AACD,QAAIA,eAAe,CAACyB,MAApB,EAA4B;AACxBzB,MAAAA,eAAe,CAACsC,IAAhB,CAAqBW,cAArB;AACH;;AACD,WAAOjD,eAAP;AACH,GA/GsC;AAgHvCkD,EAAAA,kBAAkB,EAAE,4BAAS7B,MAAT,EAAiB;AACjC,QAAIA,MAAM,IAAIjC,SAAS,CAACkB,QAAV,CAAmBe,MAAM,CAAC,CAAD,CAAzB,CAAd,EAA6C;AACzCA,MAAAA,MAAM,GAAG,CAACA,MAAD,CAAT;AACH;;AACD,WAAOA,MAAP;AACH,GArHsC;AAsHvCE,EAAAA,mBAAmB,EAAE,6BAASJ,UAAT,EAAqBE,MAArB,EAA6BD,WAA7B,EAA0C;AAC3D,QAAIjB,IAAI,GAAG,IAAX;AACA,QAAIgD,aAAa,GAAG,IAApB;AACA,QAAIC,aAAa,GAAGjC,UAAU,GAAG,CAAC,GAAD,EAAME,MAAN,CAAH,GAAmBA,MAAjD;AACA,QAAIgC,gBAAgB,GAAGlC,UAAU,GAAG,KAAH,GAAW,IAA5C;AACA,QAAInB,eAAe,GAAGG,IAAI,CAACJ,OAAL,CAAaC,eAAb,IAAgC,EAAtD;AACAA,IAAAA,eAAe,GAAGG,IAAI,CAAC+C,kBAAL,CAAwBlD,eAAxB,CAAlB;;AACA,QAAIA,eAAe,IAAIA,eAAe,CAACyB,MAAvC,EAA+C;AAC3CtB,MAAAA,IAAI,CAACmD,iBAAL,CAAuBtD,eAAvB,EAAwCqB,MAAxC,EAAgDF,UAAhD,EAA4DC,WAA5D;;AACA,UAAImC,aAAa,GAAGpD,IAAI,CAACmD,iBAAL,CAAuBtD,eAAvB,EAAwCqB,MAAxC,EAAgD,CAACF,UAAjD,CAApB;;AACA,UAAIoC,aAAa,KAAK,SAASA,aAAT,IAA0BpC,UAA1B,IAAwC,UAAUoC,aAAV,IAA2B,CAACpC,UAAzE,CAAjB,EAAuG;AACnGgC,QAAAA,aAAa,GAAG,KAAhB;AACAnD,QAAAA,eAAe,GAAG,EAAlB;AACH;;AACD,UAAImD,aAAJ,EAAmB;AACfnD,QAAAA,eAAe,GAAGG,IAAI,CAAC6C,kBAAL,CAAwBhD,eAAxB,EAAyCqD,gBAAzC,CAAlB;AACH;AACJ;;AACD,QAAIF,aAAJ,EAAmB;AACfnD,MAAAA,eAAe,CAACsC,IAAhB,CAAqBc,aAArB;AACH;;AACDpD,IAAAA,eAAe,GAAGG,IAAI,CAACqD,gBAAL,CAAsBxD,eAAtB,CAAlB;;AACAG,IAAAA,IAAI,CAACmB,UAAL,CAAgB,iBAAhB,EAAmC,CAACH,UAAD,IAAe,CAACnB,eAAe,CAACyB,MAAhC,GAAyC,IAAzC,GAAgDzB,eAAnF;AACH,GA7IsC;AA8IvCwD,EAAAA,gBAAgB,EAAE,0BAASnC,MAAT,EAAiB;AAC/B,QAAIA,MAAM,IAAI,MAAMA,MAAM,CAACI,MAA3B,EAAmC;AAC/BJ,MAAAA,MAAM,GAAGA,MAAM,CAAC,CAAD,CAAf;AACH;;AACD,WAAOA,MAAP;AACH,GAnJsC;AAoJvCoC,EAAAA,oBAAoB,EAAE,8BAASpC,MAAT,EAAiBqC,WAAjB,EAA8BtC,WAA9B,EAA2C;AAC7D,QAAIuC,mBAAJ;;AACA,QAAID,WAAW,GAAG,CAAlB,EAAqB;AACjBC,MAAAA,mBAAmB,GAAGtC,MAAM,CAACuC,MAAP,CAAcF,WAAW,GAAG,CAA5B,EAA+B,CAA/B,EAAkC,CAAlC,CAAtB;AACH,KAFD,MAEO;AACHC,MAAAA,mBAAmB,GAAGtC,MAAM,CAACuC,MAAP,CAAcF,WAAd,EAA2B,CAA3B,EAA8B,CAA9B,KAAoC,WAA1D;AACH;;AACD,QAAItC,WAAW,IAAI,UAAUuC,mBAA7B,EAAkD;AAC9CtC,MAAAA,MAAM,CAACuC,MAAP,CAAc,CAAd,EAAiBvC,MAAM,CAACI,MAAxB;AACH;;AACD,WAAOkC,mBAAP;AACH,GA/JsC;AAgKvCL,EAAAA,iBAAiB,EAAE,2BAAStD,eAAT,EAA0BqB,MAA1B,EAAkCwC,QAAlC,EAA4CzC,WAA5C,EAAyD;AACxEC,IAAAA,MAAM,GAAGwC,QAAQ,GAAG,CAAC,GAAD,EAAMxC,MAAN,CAAH,GAAmBA,MAApC;;AACA,QAAIqC,WAAW,GAAG,KAAKjB,cAAL,CAAoBzC,eAApB,EAAqCqB,MAArC,CAAlB;;AACA,QAAIsB,IAAI,CAACC,SAAL,CAAevB,MAAf,MAA2BsB,IAAI,CAACC,SAAL,CAAe5C,eAAf,CAA/B,EAAgE;AAC5DA,MAAAA,eAAe,CAAC4D,MAAhB,CAAuB,CAAvB,EAA0B5D,eAAe,CAACyB,MAA1C;AACA,aAAO,WAAP;AACH;;AACD,QAAIiC,WAAW,IAAI,CAAnB,EAAsB;AAClB,aAAO,KAAKD,oBAAL,CAA0BzD,eAA1B,EAA2C0D,WAA3C,EAAwDtC,WAAxD,CAAP;AACH,KAFD,MAEO;AACH,WAAK,IAAII,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGxB,eAAe,CAACyB,MAApC,EAA4CD,CAAC,EAA7C,EAAiD;AAC7C,YAAImC,mBAAmB,GAAGvB,KAAK,CAACC,OAAN,CAAcrC,eAAe,CAACwB,CAAD,CAA7B,KAAqCxB,eAAe,CAACwB,CAAD,CAAf,CAAmBC,MAAnB,GAA4B,CAAjE,IAAsE,KAAK6B,iBAAL,CAAuBtD,eAAe,CAACwB,CAAD,CAAtC,EAA2CH,MAA3C,EAAmD,KAAnD,EAA0DD,WAA1D,CAAhG;;AACA,YAAIuC,mBAAJ,EAAyB;AACrB,cAAI,CAAC3D,eAAe,CAACwB,CAAD,CAAf,CAAmBC,MAAxB,EAAgC;AAC5B,iBAAKgC,oBAAL,CAA0BzD,eAA1B,EAA2CwB,CAA3C,EAA8CJ,WAA9C;AACH,WAFD,MAEO;AACH,gBAAI,MAAMpB,eAAe,CAACwB,CAAD,CAAf,CAAmBC,MAA7B,EAAqC;AACjCzB,cAAAA,eAAe,CAACwB,CAAD,CAAf,GAAqBxB,eAAe,CAACwB,CAAD,CAAf,CAAmB,CAAnB,CAArB;AACH;AACJ;;AACD,iBAAOmC,mBAAP;AACH;AACJ;AACJ;AACJ,GAxLsC;AAyLvCG,EAAAA,iBAAiB,EAAE,6BAAW;AAC1B,QAAIzC,MAAM,GAAG,KAAKtB,OAAL,CAAasB,MAAb,EAAb;AACA,QAAIrB,eAAe,GAAG,KAAKD,OAAL,CAAaC,eAAnC;;AACA,QAAI,CAACA,eAAL,EAAsB;AAClB,aAAO,IAAP;AACH;;AACD,QAAI,CAACA,eAAe,CAACyB,MAArB,EAA6B;AACzB,aAAO,KAAP;AACH;;AACD,QAAI,CAACJ,MAAD,IAAW,CAACA,MAAM,CAACI,MAAvB,EAA+B;AAC3B;AACH;;AACDzB,IAAAA,eAAe,GAAG,KAAKkD,kBAAL,CAAwBlD,eAAxB,CAAlB;;AACA,QAAI,KAAK+C,gBAAL,CAAsB/C,eAAtB,EAAuCqB,MAAvC,CAAJ,EAAoD;AAChD,aAAO,IAAP;AACH;;AACD,QAAI,KAAK0B,gBAAL,CAAsB/C,eAAtB,EAAuC,CAAC,GAAD,EAAMqB,MAAN,CAAvC,CAAJ,EAA2D;AACvD,aAAO,KAAP;AACH;;AACD;AACH;AA7MsC,CAA1B,CAAjB","sourcesContent":["/**\r\n * DevExtreme (ui/selection/selection.strategy.deferred.js)\r\n * Version: 19.2.7\r\n * Build date: Thu Mar 26 2020\r\n *\r\n * Copyright (c) 2012 - 2020 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\r\n\"use strict\";\r\nvar typeUtils = require(\"../../core/utils/type\");\r\nvar SelectionStrategy = require(\"./selection.strategy\");\r\nvar errors = require(\"../widget/ui.errors\");\r\nvar dataQuery = require(\"../../data/query\");\r\nvar Deferred = require(\"../../core/utils/deferred\").Deferred;\r\nmodule.exports = SelectionStrategy.inherit({\r\n    getSelectedItems: function() {\r\n        return this._loadFilteredData(this.options.selectionFilter)\r\n    },\r\n    getSelectedItemKeys: function() {\r\n        var d = new Deferred;\r\n        var that = this;\r\n        var key = this.options.key();\r\n        var select = typeUtils.isString(key) ? [key] : key;\r\n        this._loadFilteredData(this.options.selectionFilter, null, select).done(function(items) {\r\n            var keys = items.map(function(item) {\r\n                return that.options.keyOf(item)\r\n            });\r\n            d.resolve(keys)\r\n        }).fail(d.reject);\r\n        return d.promise()\r\n    },\r\n    selectedItemKeys: function(keys, preserve, isDeselect, isSelectAll) {\r\n        if (isSelectAll) {\r\n            var filter = this.options.filter();\r\n            if (!filter) {\r\n                this._setOption(\"selectionFilter\", isDeselect ? [] : null)\r\n            } else {\r\n                this._addSelectionFilter(isDeselect, filter, isSelectAll)\r\n            }\r\n        } else {\r\n            if (!preserve) {\r\n                this._setOption(\"selectionFilter\", [])\r\n            }\r\n            for (var i = 0; i < keys.length; i++) {\r\n                if (isDeselect) {\r\n                    this.removeSelectedItem(keys[i])\r\n                } else {\r\n                    this.addSelectedItem(keys[i])\r\n                }\r\n            }\r\n        }\r\n        this.onSelectionChanged();\r\n        return (new Deferred).resolve()\r\n    },\r\n    setSelectedItems: function(keys) {\r\n        this._setOption(\"selectionFilter\", null);\r\n        for (var i = 0; i < keys.length; i++) {\r\n            this.addSelectedItem(keys[i])\r\n        }\r\n    },\r\n    isItemDataSelected: function(itemData) {\r\n        return this.isItemKeySelected(itemData)\r\n    },\r\n    isItemKeySelected: function(itemData) {\r\n        var selectionFilter = this.options.selectionFilter;\r\n        if (!selectionFilter) {\r\n            return true\r\n        }\r\n        return !!dataQuery([itemData]).filter(selectionFilter).toArray().length\r\n    },\r\n    _processSelectedItem: function(key) {\r\n        var keyField = this.options.key();\r\n        var filter = [keyField, \"=\", key];\r\n        if (Array.isArray(keyField)) {\r\n            filter = [];\r\n            for (var i = 0; i < keyField.length; i++) {\r\n                filter.push([keyField[i], \"=\", key[keyField[i]]]);\r\n                if (i !== keyField.length - 1) {\r\n                    filter.push(\"and\")\r\n                }\r\n            }\r\n        }\r\n        return filter\r\n    },\r\n    addSelectedItem: function(key) {\r\n        var filter = this._processSelectedItem(key);\r\n        this._addSelectionFilter(false, filter)\r\n    },\r\n    removeSelectedItem: function(key) {\r\n        var filter = this._processSelectedItem(key);\r\n        this._addSelectionFilter(true, filter)\r\n    },\r\n    validate: function() {\r\n        var key = this.options.key;\r\n        if (key && void 0 === key()) {\r\n            throw errors.Error(\"E1042\", \"Deferred selection\")\r\n        }\r\n    },\r\n    _findSubFilter: function(selectionFilter, filter) {\r\n        if (!selectionFilter) {\r\n            return -1\r\n        }\r\n        var filterString = JSON.stringify(filter);\r\n        for (var index = 0; index < selectionFilter.length; index++) {\r\n            var subFilter = selectionFilter[index];\r\n            if (subFilter && JSON.stringify(subFilter) === filterString) {\r\n                return index\r\n            }\r\n        }\r\n        return -1\r\n    },\r\n    _isLastSubFilter: function(selectionFilter, filter) {\r\n        if (selectionFilter && filter) {\r\n            return this._findSubFilter(selectionFilter, filter) === selectionFilter.length - 1 || 0 === this._findSubFilter([selectionFilter], filter)\r\n        }\r\n        return false\r\n    },\r\n    _addFilterOperator: function(selectionFilter, filterOperator) {\r\n        if (selectionFilter.length > 1 && typeUtils.isString(selectionFilter[1]) && selectionFilter[1] !== filterOperator) {\r\n            selectionFilter = [selectionFilter]\r\n        }\r\n        if (selectionFilter.length) {\r\n            selectionFilter.push(filterOperator)\r\n        }\r\n        return selectionFilter\r\n    },\r\n    _denormalizeFilter: function(filter) {\r\n        if (filter && typeUtils.isString(filter[0])) {\r\n            filter = [filter]\r\n        }\r\n        return filter\r\n    },\r\n    _addSelectionFilter: function(isDeselect, filter, isSelectAll) {\r\n        var that = this;\r\n        var needAddFilter = true;\r\n        var currentFilter = isDeselect ? [\"!\", filter] : filter;\r\n        var currentOperation = isDeselect ? \"and\" : \"or\";\r\n        var selectionFilter = that.options.selectionFilter || [];\r\n        selectionFilter = that._denormalizeFilter(selectionFilter);\r\n        if (selectionFilter && selectionFilter.length) {\r\n            that._removeSameFilter(selectionFilter, filter, isDeselect, isSelectAll);\r\n            var lastOperation = that._removeSameFilter(selectionFilter, filter, !isDeselect);\r\n            if (lastOperation && (\"or\" !== lastOperation && isDeselect || \"and\" !== lastOperation && !isDeselect)) {\r\n                needAddFilter = false;\r\n                selectionFilter = []\r\n            }\r\n            if (needAddFilter) {\r\n                selectionFilter = that._addFilterOperator(selectionFilter, currentOperation)\r\n            }\r\n        }\r\n        if (needAddFilter) {\r\n            selectionFilter.push(currentFilter)\r\n        }\r\n        selectionFilter = that._normalizeFilter(selectionFilter);\r\n        that._setOption(\"selectionFilter\", !isDeselect && !selectionFilter.length ? null : selectionFilter)\r\n    },\r\n    _normalizeFilter: function(filter) {\r\n        if (filter && 1 === filter.length) {\r\n            filter = filter[0]\r\n        }\r\n        return filter\r\n    },\r\n    _removeFilterByIndex: function(filter, filterIndex, isSelectAll) {\r\n        var lastRemoveOperation;\r\n        if (filterIndex > 0) {\r\n            lastRemoveOperation = filter.splice(filterIndex - 1, 2)[0]\r\n        } else {\r\n            lastRemoveOperation = filter.splice(filterIndex, 2)[1] || \"undefined\"\r\n        }\r\n        if (isSelectAll && \"and\" === lastRemoveOperation) {\r\n            filter.splice(0, filter.length)\r\n        }\r\n        return lastRemoveOperation\r\n    },\r\n    _removeSameFilter: function(selectionFilter, filter, inverted, isSelectAll) {\r\n        filter = inverted ? [\"!\", filter] : filter;\r\n        var filterIndex = this._findSubFilter(selectionFilter, filter);\r\n        if (JSON.stringify(filter) === JSON.stringify(selectionFilter)) {\r\n            selectionFilter.splice(0, selectionFilter.length);\r\n            return \"undefined\"\r\n        }\r\n        if (filterIndex >= 0) {\r\n            return this._removeFilterByIndex(selectionFilter, filterIndex, isSelectAll)\r\n        } else {\r\n            for (var i = 0; i < selectionFilter.length; i++) {\r\n                var lastRemoveOperation = Array.isArray(selectionFilter[i]) && selectionFilter[i].length > 2 && this._removeSameFilter(selectionFilter[i], filter, false, isSelectAll);\r\n                if (lastRemoveOperation) {\r\n                    if (!selectionFilter[i].length) {\r\n                        this._removeFilterByIndex(selectionFilter, i, isSelectAll)\r\n                    } else {\r\n                        if (1 === selectionFilter[i].length) {\r\n                            selectionFilter[i] = selectionFilter[i][0]\r\n                        }\r\n                    }\r\n                    return lastRemoveOperation\r\n                }\r\n            }\r\n        }\r\n    },\r\n    getSelectAllState: function() {\r\n        var filter = this.options.filter();\r\n        var selectionFilter = this.options.selectionFilter;\r\n        if (!selectionFilter) {\r\n            return true\r\n        }\r\n        if (!selectionFilter.length) {\r\n            return false\r\n        }\r\n        if (!filter || !filter.length) {\r\n            return\r\n        }\r\n        selectionFilter = this._denormalizeFilter(selectionFilter);\r\n        if (this._isLastSubFilter(selectionFilter, filter)) {\r\n            return true\r\n        }\r\n        if (this._isLastSubFilter(selectionFilter, [\"!\", filter])) {\r\n            return false\r\n        }\r\n        return\r\n    }\r\n});\r\n"]},"metadata":{},"sourceType":"script"}